name: Migration Validation

on:
  push:
    branches: [ develop, main ]
    paths:
      - 'database/migrations/**'
  pull_request:
    branches: [ develop, main ]
    paths:
      - 'database/migrations/**'

jobs:
  validate-migration-headers:
    runs-on: ubuntu-latest
    name: Validate Migration Headers

    steps:
      - uses: actions/checkout@v4

      - name: Check migration metadata headers
        run: |
          echo "Validating migration file headers..."

          # Required metadata fields in migration files
          REQUIRED_FIELDS=("migration:" "description:" "author:" "trace:" "last-updated:")

          # Find all migration files
          MIGRATIONS=$(find database/migrations -name "*.php" -type f)
          FAILED=0

          for migration in $MIGRATIONS; do
            echo "Checking: $migration"

            for field in "${REQUIRED_FIELDS[@]}"; do
              if ! grep -q "$field" "$migration"; then
                echo "  ❌ Missing field: $field"
                FAILED=$((FAILED + 1))
              else
                echo "  ✅ Found: $field"
              fi
            done
          done

          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "❌ $FAILED migration(s) missing required metadata headers"
            echo "See docs/MIGRATION_TEMPLATE.md for the required format"
            exit 1
          else
            echo ""
            echo "✅ All migrations have required metadata headers"
            exit 0
          fi

      - name: Verify migration reversibility
        run: |
          echo "Checking migration down() methods..."

          MIGRATIONS=$(find database/migrations -name "*.php" -type f)
          FAILED=0

          for migration in $MIGRATIONS; do
            if ! grep -q "public function down" "$migration"; then
              echo "❌ Missing down() method in $migration"
              FAILED=$((FAILED + 1))
            fi
          done

          if [ $FAILED -gt 0 ]; then
            echo "❌ $FAILED migration(s) missing down() method"
            exit 1
          else
            echo "✅ All migrations have down() methods"
            exit 0
          fi

      - name: Lint PHP syntax
        run: |
          php -l database/migrations/*.php || {
            echo "❌ PHP syntax errors in migration files"
            exit 1
          }
          echo "✅ All migrations have valid PHP syntax"

      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Migration Validation Failed**\n\n' +
                    'See CI logs for details. Ensure all migrations include:\n' +
                    '- `migration:` field\n' +
                    '- `description:` field\n' +
                    '- `author:` field\n' +
                    '- `trace:` field (SRS IDs + Design refs)\n' +
                    '- `last-updated:` field\n' +
                    '- `down()` method for reversibility\n\n' +
                    'See [Migration Template](docs/MIGRATION_TEMPLATE.md) for the required format.'
            })

      - name: Comment success on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Migration Validation Passed**\n\n' +
                    '- All migrations have required metadata headers\n' +
                    '- All migrations have down() methods\n' +
                    '- All migrations have valid PHP syntax'
            })
