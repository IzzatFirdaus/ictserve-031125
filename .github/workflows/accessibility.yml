name: Accessibility Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  accessibility-tests:
    name: WCAG 2.2 Level AA Compliance
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: ictserve_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Install Node dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run database migrations
        run: php artisan migrate --force

      - name: Run PHPUnit accessibility tests
        run: php artisan test --filter=AccessibilityTest

      - name: Start Laravel server
        run: php artisan serve --host=0.0.0.0 --port=8000 &
        env:
          APP_ENV: testing

      - name: Wait for server
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:8000 > /dev/null; do sleep 1; done'

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x

      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Install Pa11y
        run: npm install -g pa11y

      - name: Run Pa11y accessibility tests
        run: |
          pa11y --standard WCAG2AA --reporter json http://localhost:8000 > pa11y-report.json || true
          pa11y --standard WCAG2AA http://localhost:8000/login || true
          pa11y --standard WCAG2AA http://localhost:8000/dashboard || true

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/

      - name: Upload Pa11y reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pa11y-reports
          path: pa11y-report.json

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            let comment = '## Accessibility Test Results\n\n';

            // Add Lighthouse results if available
            try {
              const lhciResults = fs.readFileSync('.lighthouseci/manifest.json', 'utf8');
              const manifest = JSON.parse(lhciResults);
              comment += '### Lighthouse Accessibility Score\n\n';
              manifest.forEach(result => {
                const score = result.summary.accessibility * 100;
                const emoji = score >= 90 ? '✅' : '❌';
                comment += `${emoji} ${result.url}: ${score.toFixed(0)}/100\n`;
              });
            } catch (e) {
              comment += '⚠️ Lighthouse results not available\n';
            }

            comment += '\n### Pa11y Results\n\n';
            try {
              const pa11yResults = fs.readFileSync('pa11y-report.json', 'utf8');
              const results = JSON.parse(pa11yResults);
              const errorCount = results.issues.filter(i => i.type === 'error').length;
              const warningCount = results.issues.filter(i => i.type === 'warning').length;
              const emoji = errorCount === 0 ? '✅' : '❌';
              comment += `${emoji} Errors: ${errorCount}, Warnings: ${warningCount}\n`;
            } catch (e) {
              comment += '⚠️ Pa11y results not available\n';
            }

            comment += '\n---\n';
            comment += 'For detailed reports, check the workflow artifacts.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  axe-tests:
    name: axe-core Automated Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install axe-core
        run: npm install -D @axe-core/cli

      - name: Build assets
        run: npm run build

      - name: Setup PHP and start server
        run: |
          sudo apt-get update
          sudo apt-get install -y php8.2 php8.2-cli php8.2-mbstring php8.2-xml
          php -S localhost:8000 -t public &
          sleep 5

      - name: Run axe-core tests
        run: |
          npx axe http://localhost:8000 --exit || true
          npx axe http://localhost:8000/login --exit || true

  color-contrast:
    name: Color Contrast Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install color-contrast-checker
        run: npm install -g color-contrast-checker

      - name: Validate MOTAC color palette
        run: |
          echo "Checking MOTAC primary colors..."
          # Blue on white
          npx color-contrast-checker --foreground "#003366" --background "#FFFFFF" --level AA
          # White on blue
          npx color-contrast-checker --foreground "#FFFFFF" --background "#003366" --level AA
          # Success green
          npx color-contrast-checker --foreground "#15803d" --background "#FFFFFF" --level AA
          # Error red
          npx color-contrast-checker --foreground "#b91c1c" --background "#FFFFFF" --level AA
          # Warning yellow
          npx color-contrast-checker --foreground "#a16207" --background "#FFFFFF" --level AA

  summary:
    name: Accessibility Test Summary
    runs-on: ubuntu-latest
    needs: [accessibility-tests, axe-tests, color-contrast]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.accessibility-tests.result }}" == "failure" ] || \
             [ "${{ needs.axe-tests.result }}" == "failure" ] || \
             [ "${{ needs.color-contrast.result }}" == "failure" ]; then
            echo "❌ Accessibility tests failed"
            exit 1
          else
            echo "✅ All accessibility tests passed"
          fi
